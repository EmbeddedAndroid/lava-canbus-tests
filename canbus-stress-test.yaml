metadata:
    name: canbus-stress-test
    format: "Lava-Test-Shell Test Definition 1.0"
    description: "Canbus stress test (12 hour default)"
    maintainer:
        - tyler.baker@linaro.org
    devices:
        - beaglebone-black

params:
    DEVICE: /dev/sda1
    TIMEOUT: 43200s

run:
    steps:
        - 'mkdir -p ~/tmp'
        - 'mkfs -F -t ext4 $DEVICE'
        - 'mount $DEVICE ~/tmp/'
        - 'cd ~/tmp/'
        - 'candump can0 > ~/tmp/log.txt &'
        - 'echo $! > /tmp/candump.pid'
        - 'timeout -s SIGINT $TIMEOUT cansequence -e -p || true'
        - 'kill -9 `cat /tmp/candump.pid`'
        - 'umount $DEVICE'
        - 'cat /proc/net/can/stats'
        - 'ls -alh ~/tmp | grep log.txt'
        - 'lava-test-case canbus-stress-test --result pass'